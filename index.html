<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webç”»é¢åˆæˆãƒ„ãƒ¼ãƒ« (OBSé¢¨)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .placeholder-bg {
            background-image:
                linear-gradient(45deg, #2d3748 25%, transparent 25%),
                linear-gradient(-45deg, #2d3748 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #2d3748 75%),
                linear-gradient(-45deg, transparent 75%, #2d3748 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        /* ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body.presentation-mode {
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™ */
        }
        body.presentation-mode .hide-in-presentation {
            display: none !important; /* ã“ã®ã‚¯ãƒ©ã‚¹ã‚’æŒã¤UIè¦ç´ ã‚’éè¡¨ç¤º */
        }
        body.presentation-mode #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            border-radius: 0;
            border: none;
        }
        body.presentation-mode #togglePresentationMode {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            opacity: 0.15;
            transition: opacity 0.3s ease-in-out;
        }
        body.presentation-mode #togglePresentationMode:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <main class="flex-grow container mx-auto p-4 md:p-6">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="text-center mb-6 hide-in-presentation">
            <h1 class="text-3xl md:text-4xl font-bold">Webç”»é¢åˆæˆãƒ„ãƒ¼ãƒ« (OBSé¢¨)</h1>
            <p class="text-gray-400 mt-2">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€‚2ã¤ã®ç”»é¢ã‚„ã‚«ãƒ¡ãƒ©ã‚’1ã¤ã«åˆæˆã—ã€Google Meetã§å…±æœ‰ã§ãã¾ã™ã€‚</p>
        </div>

        <!-- ä½¿ã„æ–¹ -->
        <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg mb-6 max-w-4xl mx-auto hide-in-presentation">
            <h2 class="text-xl font-semibold mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                ä½¿ã„æ–¹
            </h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
                <li><strong class="text-yellow-400">é‡è¦:</strong> ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€<strong class="text-yellow-400">ä»–ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åˆæˆã™ã‚‹ãŸã‚ã®èˆå°</strong>ã§ã™ã€‚ã‚½ãƒ¼ã‚¹é¸æŠæ™‚ã«ã€ã“ã®ãƒ„ãƒ¼ãƒ«è‡ªä½“ã®ã‚¿ãƒ–ã¯é¸ã°ãªã„ã§ãã ã•ã„ã€‚</li>
                <li>ä¸‹ã®ã€Œã‚½ãƒ¼ã‚¹1ã€ã€Œã‚½ãƒ¼ã‚¹2ã€ã§ã€å…±æœ‰ã—ãŸã„<strong class="text-yellow-400">åˆ¥ã®</strong>ã‚¢ãƒ—ãƒªã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã‚’é¸æŠã—ã¾ã™ã€‚</li>
                <li>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é¸ã³ã€ä¸­å¤®ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æ˜ åƒãŒåˆæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</li>
                <li>Google Meetã§ç”»é¢å…±æœ‰ã‚’é–‹å§‹ã—ã€ã€Œ<strong>ã‚¿ãƒ–ã‚’å…±æœ‰</strong>ã€ã‹ã‚‰ã€Œ<strong class="text-teal-400">Webç”»é¢åˆæˆãƒ„ãƒ¼ãƒ« (OBSé¢¨)</strong>ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</li>
            </ol>
        </div>
        
        <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé¸æŠ -->
        <div class="flex justify-center items-center gap-4 mb-6 hide-in-presentation">
            <h3 class="text-lg font-semibold">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:</h3>
            <button id="layout-side-by-side" class="bg-gray-700 hover:bg-teal-600 border-2 border-teal-500 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">å·¦å³åˆ†å‰²</button>
            <button id="layout-pip" class="bg-gray-700 hover:bg-teal-600 border-2 border-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">å°çª“ (PiP)</button>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="flex flex-col lg:flex-row items-center justify-center gap-4">
            
            <!-- ã‚½ãƒ¼ã‚¹1 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="w-full lg:w-1/5 bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center space-y-3 hide-in-presentation">
                <h3 class="text-lg font-bold">ã‚½ãƒ¼ã‚¹1</h3>
                <button id="selectScreen1" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">ç”»é¢ã‚’é¸æŠ</button>
                <button id="selectCamera1" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠ</button>
                <button id="reset1" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 mt-2">ãƒªã‚»ãƒƒãƒˆ</button>
                <p id="status1" class="text-sm text-gray-400 h-4 mt-1">æœªé¸æŠ</p>
            </div>

            <!-- åˆæˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div id="canvas-container" class="w-full lg:w-3/5 aspect-video bg-black rounded-lg shadow-2xl border-2 border-gray-700 overflow-hidden">
                <canvas id="compositeCanvas" class="w-full h-full placeholder-bg"></canvas>
            </div>

            <!-- ã‚½ãƒ¼ã‚¹2 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="w-full lg:w-1/5 bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center space-y-3 hide-in-presentation">
                <h3 class="text-lg font-bold">ã‚½ãƒ¼ã‚¹2</h3>
                <button id="selectScreen2" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">ç”»é¢ã‚’é¸æŠ</button>
                <button id="selectCamera2" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠ</button>
                <button id="reset2" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 mt-2">ãƒªã‚»ãƒƒãƒˆ</button>
                <p id="status2" class="text-sm text-gray-400 h-4 mt-1">æœªé¸æŠ</p>
            </div>
        </div>

         <!-- ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
         <div class="flex justify-center mt-6 hide-in-presentation">
             <button id="togglePresentationMode" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center">
                <svg id="presentation-icon-expand" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                <svg id="presentation-icon-compress" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 hidden"><path d="M15 3h6v6m-11 5L21 3m-6 12v6h-6m5-11L3 21"></path></svg>
                <span id="presentationModeText">å…¨ç”»é¢è¡¨ç¤º</span>
            </button>
        </div>

        <!-- è¨ºæ–­ç”¨ãƒ‘ãƒãƒ« (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚æç”»ãŒæ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã€ç”»é¢éš…ã«å°ã•ãå›ºå®šè¡¨ç¤º) -->
        <div class="fixed bottom-0 left-0 w-px h-px opacity-0 pointer-events-none -z-10">
            <video id="source1VideoDebug" playsinline autoplay muted></video>
            <video id="source2VideoDebug" playsinline autoplay muted></video>
        </div>

    </main>

    <!-- åˆå›è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="firstTimeWarningModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto border border-yellow-500">
            <h3 class="text-xl font-bold text-yellow-400 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                é‡è¦ãªä½¿ã„æ–¹
            </h3>
            <p class="text-gray-300 mb-4">
                ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€<strong>ä»–ã®</strong>ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚„ã‚¿ãƒ–ã‚’åˆæˆã™ã‚‹ãŸã‚ã®ã€Œèˆå°ã€ã§ã™ã€‚
            </p>
            <p class="text-gray-300 mb-6">
                ã‚½ãƒ¼ã‚¹ã‚’é¸æŠã™ã‚‹éš›ã€<strong>ã“ã®ãƒ„ãƒ¼ãƒ«è‡ªä½“ã®ã‚¿ãƒ–ã¯çµ¶å¯¾ã«é¸ã°ãªã„ã§ãã ã•ã„ã€‚</strong>ãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ã«ã‚ˆã‚Šã€ç”»é¢ãŒçœŸã£é»’ã«ãªã‚Šã€æ­£å¸¸ã«å‹•ä½œã—ã¾ã›ã‚“ã€‚
            </p>
            <button id="closeWarningModal" class="w-full bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded-md transition-colors duration-200">ç†è§£ã—ã¾ã—ãŸ</button>
        </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="permissionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 max-w-md w-full mx-auto border border-gray-700">
            <h3 class="text-xl font-bold text-red-400 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ©ãƒ¼
            </h3>
            <p class="text-gray-300 mb-4">
                ç”»é¢å…±æœ‰ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã€ã“ã®ãƒšãƒ¼ã‚¸ã«å¯¾ã™ã‚‹ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã®æ¨©é™ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
            </p>
            <p class="text-gray-300 mb-6">
                ã“ã®ãƒ„ãƒ¼ãƒ«ãŒåˆ¥ã®ãƒšãƒ¼ã‚¸ã«åŸ‹ã‚è¾¼ã¾ã‚Œã¦å‹•ä½œã—ã¦ã„ã‚‹å ´åˆã€åŸ‹ã‚è¾¼ã¿å…ƒã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã£ã¦æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåŸå› ã§ã™ã€‚
            </p>
            <button id="closeModal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <footer class="text-center text-gray-500 text-sm p-4 hide-in-presentation">
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®æ©Ÿèƒ½ã®ã¿ã§å‹•ä½œã—ã¾ã™ã€‚æ˜ åƒãƒ‡ãƒ¼ã‚¿ãŒå¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </footer>

    <script>
        const canvas = document.getElementById('compositeCanvas');
        const ctx = canvas.getContext('2d');
        const video1Debug = document.getElementById('source1VideoDebug');
        const video2Debug = document.getElementById('source2VideoDebug');
        const status1 = document.getElementById('status1');
        const status2 = document.getElementById('status2');
        const modal = document.getElementById('permissionModal');
        const closeModalBtn = document.getElementById('closeModal');
        const warningModal = document.getElementById('firstTimeWarningModal');
        const closeWarningModalBtn = document.getElementById('closeWarningModal');
        const layoutSideBySideBtn = document.getElementById('layout-side-by-side');
        const layoutPipBtn = document.getElementById('layout-pip');
        const togglePresentationModeBtn = document.getElementById('togglePresentationMode');
        const presentationModeText = document.getElementById('presentationModeText');
        const iconExpand = document.getElementById('presentation-icon-expand');
        const iconCompress = document.getElementById('presentation-icon-compress');


        let stream1 = null;
        let stream2 = null;
        let currentLayout = 'side-by-side';
        let pendingAction = null;

        canvas.width = 1280;
        canvas.height = 720;
        
        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        closeWarningModalBtn.addEventListener('click', () => {
            warningModal.classList.add('hidden');
            localStorage.setItem('webObsToolWarningSeen', 'true');
            if (pendingAction) {
                pendingAction();
                pendingAction = null;
            }
        });

        function updateLayoutButtons() {
            if (currentLayout === 'side-by-side') {
                layoutSideBySideBtn.classList.add('border-teal-500');
                layoutSideBySideBtn.classList.remove('border-gray-700');
                layoutPipBtn.classList.add('border-gray-700');
                layoutPipBtn.classList.remove('border-teal-500');
            } else {
                layoutPipBtn.classList.add('border-teal-500');
                layoutPipBtn.classList.remove('border-gray-700');
                layoutSideBySideBtn.classList.add('border-gray-700');
                layoutSideBySideBtn.classList.remove('border-teal-500');
            }
        }

        layoutSideBySideBtn.addEventListener('click', () => {
            currentLayout = 'side-by-side';
            updateLayoutButtons();
        });
        layoutPipBtn.addEventListener('click', () => {
            currentLayout = 'pip';
            updateLayoutButtons();
        });

        document.getElementById('selectScreen1').addEventListener('click', () => triggerSourceSelection('display', 1));
        document.getElementById('selectCamera1').addEventListener('click', () => triggerSourceSelection('user', 1));
        document.getElementById('selectScreen2').addEventListener('click', () => triggerSourceSelection('display', 2));
        document.getElementById('selectCamera2').addEventListener('click', () => triggerSourceSelection('user', 2));

        document.getElementById('reset1').addEventListener('click', () => resetSource(1));
        document.getElementById('reset2').addEventListener('click', () => resetSource(2));

        function triggerSourceSelection(type, sourceNum) {
            const action = () => handleSourceSelection(type, sourceNum);

            if (type === 'display' && !localStorage.getItem('webObsToolWarningSeen')) {
                pendingAction = action;
                warningModal.classList.remove('hidden');
            } else {
                action();
            }
        }

        async function handleSourceSelection(type, sourceNum) {
            try {
                const stream = await navigator.mediaDevices[type === 'display' ? 'getDisplayMedia' : 'getUserMedia']({ video: true, audio: false });
                
                if (sourceNum === 1) {
                    stream1 = stream;
                    video1Debug.srcObject = stream;
                    status1.textContent = type === 'display' ? 'ç”»é¢ã‚’é¸æŠä¸­' : 'ã‚«ãƒ¡ãƒ©ã‚’é¸æŠä¸­';
                } else { // sourceNum === 2
                    stream2 = stream;
                    video2Debug.srcObject = stream;
                    status2.textContent = type === 'display' ? 'ç”»é¢ã‚’é¸æŠä¸­' : 'ã‚«ãƒ¡ãƒ©ã‚’é¸æŠä¸­';
                }

                stream.getVideoTracks()[0].onended = () => resetSource(sourceNum);
            } catch (err) {
                console.error("Error selecting source:", err);
                if (err.name === 'NotAllowedError') {
                    if(sourceNum === 1) status1.textContent = 'ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
                    else status2.textContent = 'ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
                    modal.classList.remove('hidden');
                } else {
                    if(sourceNum === 1) status1.textContent = 'é¸æŠå¤±æ•—';
                    else status2.textContent = 'é¸æŠå¤±æ•—';
                }
            }
        }

        function resetSource(sourceNum) {
            if (sourceNum === 1) {
                if (stream1) {
                    stream1.getTracks().forEach(track => track.stop());
                }
                stream1 = null;
                video1Debug.srcObject = null;
                status1.textContent = 'æœªé¸æŠ';
            } else { // sourceNum === 2
                if (stream2) {
                    stream2.getTracks().forEach(track => track.stop());
                }
                stream2 = null;
                video2Debug.srcObject = null;
                status2.textContent = 'æœªé¸æŠ';
            }
        }
        
        function getLines(ctx, text, maxWidth) {
            const words = text.split(" ");
            let lines = [];
            if (!words.length) return lines;
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        function drawPlaceholder(x, y, w, h, text, isError = false) {
            ctx.fillStyle = isError ? '#5f2120' : '#2d3748';
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = 'white';
            ctx.font = '20px "Inter"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const lines = getLines(ctx, text, w - 40);
            const lineHeight = 24;
            const totalHeight = lines.length * lineHeight;
            let startY = y + (h - totalHeight) / 2 + (lineHeight / 2) - 4;

            lines.forEach((line, i) => {
                ctx.fillText(line, x + w / 2, startY + i * lineHeight);
            });
        }

        function drawVideoWithAspectRatio(video, x, y, w, h) {
             if (video.videoWidth === 0 || !video.srcObject) { // !video.srcObject ã‚’è¿½åŠ 
                 const errorText = "ğŸš« è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚ã“ã®ãƒ„ãƒ¼ãƒ«è‡ªä½“ã‚’é¸æŠã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿã€Œãƒªã‚»ãƒƒãƒˆã€ã‚’æŠ¼ã—ã¦ã€åˆ¥ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é¸ã³ç›´ã—ã¦ãã ã•ã„ã€‚";
                 drawPlaceholder(x, y, w, h, errorText, true);
                 return;
             }
            const videoAspect = video.videoWidth / video.videoHeight;
            const canvasAspect = w / h;
            let drawWidth, drawHeight, offsetX, offsetY;

            if (videoAspect > canvasAspect) {
                drawWidth = w;
                drawHeight = drawWidth / videoaspect;
                offsetX = x;
                offsetY = y + (h - drawHeight) / 2;
            } else {
                drawHeight = h;
                drawWidth = drawHeight * videoAspect;
                offsetX = x + (w - drawWidth) / 2;
                offsetY = y;
            }
            ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);
        }

        function drawCanvas() {
            ctx.fillStyle = '#1a202c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (currentLayout === 'side-by-side') {
                const halfWidth = canvas.width / 2;
                if (stream1) drawVideoWithAspectRatio(video1Debug, 0, 0, halfWidth, canvas.height);
                else drawPlaceholder(0, 0, halfWidth, canvas.height, 'ã‚½ãƒ¼ã‚¹1ã‚’é¸æŠ');
                
                if (stream2) drawVideoWithAspectRatio(video2Debug, halfWidth, 0, halfWidth, canvas.height);
                else drawPlaceholder(halfWidth, 0, halfWidth, canvas.height, 'ã‚½ãƒ¼ã‚¹2ã‚’é¸æŠ');

                ctx.fillStyle = '#4a5568';
                ctx.fillRect(halfWidth - 1, 0, 2, canvas.height);
            } else if (currentLayout === 'pip') {
                const pipWidth = canvas.width * 0.3;
                const pipHeight = pipWidth / (16/9);
                const margin = canvas.width * 0.015;

                if (stream1) drawVideoWithAspectRatio(video1Debug, 0, 0, canvas.width, canvas.height);
                else drawPlaceholder(0, 0, canvas.width, canvas.height, 'ã‚½ãƒ¼ã‚¹1 (èƒŒæ™¯) ã‚’é¸æŠ');

                if (stream2) {
                    ctx.save();
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 15;
                    drawVideoWithAspectRatio(video2Debug, canvas.width - pipWidth - margin, canvas.height - pipHeight - margin, pipWidth, pipHeight);
                    ctx.strokeStyle = '#4a5568';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(canvas.width - pipWidth - margin, canvas.height - pipHeight - margin, pipWidth, pipHeight);
                    ctx.restore();
                } else {
                     drawPlaceholder(canvas.width - pipWidth - margin, canvas.height - pipHeight - margin, pipWidth, pipHeight, 'ã‚½ãƒ¼ã‚¹2');
                }
            }
            requestAnimationFrame(drawCanvas);
        }
        
        // --- ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
        // UIã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ¶å¾¡ã—ã¾ã™
        function updatePresentationModeUI() {
            // bodyã« 'presentation-mode' ã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹ã‹ã©ã†ã‹ã§è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            if (document.body.classList.contains('presentation-mode')) {
                // --- ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼ˆUIéè¡¨ç¤ºï¼‰ ---
                // CSSã«ã‚ˆã£ã¦ .hide-in-presentation ã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ãŒéè¡¨ç¤ºã«ãªã‚‹
                presentationModeText.textContent = 'ç·¨é›†ã«æˆ»ã‚‹';
                iconExpand.classList.add('hidden');
                iconCompress.classList.remove('hidden');
            } else {
                // --- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆUIè¡¨ç¤ºï¼‰ ---
                // CSSã®ã‚»ãƒ¬ã‚¯ã‚¿ãŒä¸€è‡´ã—ãªããªã‚Šã€UIè¦ç´ ãŒé€šå¸¸é€šã‚Šè¡¨ç¤ºã•ã‚Œã‚‹
                presentationModeText.textContent = 'å…¨ç”»é¢è¡¨ç¤º';
                iconExpand.classList.remove('hidden');
                iconCompress.classList.add('hidden');
            }
        }

        // ã€Œå…¨ç”»é¢è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        togglePresentationModeBtn.addEventListener('click', () => {
            // bodyã‚¿ã‚°ã« 'presentation-mode' ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ãŸã‚Šå¤–ã—ãŸã‚Šã™ã‚‹
            document.body.classList.toggle('presentation-mode');
            // è¡¨ç¤ºã‚’æ›´æ–°
            updatePresentationModeUI();
        });

        // Escapeã‚­ãƒ¼ã§ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã™ã‚‹å‡¦ç†
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && document.body.classList.contains('presentation-mode')) {
                document.body.classList.remove('presentation-mode');
                updatePresentationModeUI();
            }
        });


        // åˆæœŸåŒ–å‡¦ç†
        updateLayoutButtons();
        drawCanvas();
    </script>
</body>
</html>

